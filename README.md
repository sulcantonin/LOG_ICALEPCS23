# Unsupervised Log Anomaly Detection with Few Unique Tokens
This article introduces a method to detect anomalies in the log data generated by control system nodes at the European XFEL accelerator. The primary aim of this proposed method is to provide operators a comprehensive understanding of the availability, status, and problems specific to each node. This information is vital for ensuring the smooth operation. The sequential nature of logs and the absence of a rich text corpus that is specific to our nodes poses significant limitations for traditional and learning-based approaches for anomaly detection. To overcome this limitation, we propose a method that uses word embedding and models individual nodes as a sequence of these vectors that commonly co-occur, using a Hidden Markov Model (HMM). We score individual log entries by computing a probability ratio between the probability of the full log sequence including the new entry and the probability of just the previous log entries, without the new entry. This ratio indicates how probable the sequence becomes when the new entry is added. The proposed approach can detect anomalies by scoring and ranking log entries from EuXFEL nodes where entries that receive high scores are potential anomalies that do not fit the routine of the node. This method provides a warning system to alert operators about these irregular log events that may indicate issues.

[Submission](TH2AO01.pdf) | [Talk](TH2AO01_TALK.pdf)

## Prerequisties 
```bash
pip intall hmmlearn==0.2.7 numpy
```

## Example
```python
from hmmlearn import hmm
import numpy as np

x = np.stack([[0,1],[1,0],[0,1],[1,0],[0,1],[1,0],[0,1],[1,0]])
model = hmm.GaussianHMM(n_components=2, covariance_type="diag")
model.fit(x[:-1,:])
logp = []
for i in range(1,x.shape[0]+1):
    logp.append(model.score(x[:i]))

logp = np.array(logp)
score = logp[:-1] - logp[1:]

```

## Demo from paper (Figure 1 & 3)
```python
from hmmlearn import hmm
import numpy as np
import matplotlib.pyplot as plt
from pprint import pprint
plt.rcParams['text.usetex'] = False

state_dict = {
    '0' : np.array([0,1]),
    '1' : np.array([1,0]),
    'a' : np.array([1,1])}

def plot_seq_online(seq, draw_dot_at = False):
    x = []
    for i in range(len(seq)):
        x.append(state_dict[seq[i]])
    x = np.stack(x)
    model = hmm.GaussianHMM(n_components=2, covariance_type="diag")
    model.fit(x[:-1,:]) # excluding last element from seq
    score = []
    for i in range(1,x.shape[0]+1):
        score.append(model.score(x[:i]))
    score = np.array(score)
    print(len(seq), len(score))
    s = score[1:] - score[:-1]
    s = np.insert(s,0, s.max())
    plt.plot(np.array(range(len(s)))+1, -s)
    if draw_dot_at:
        plt.plot(len(s),-s[-1],'ro')
    plt.xlabel('Event number', fontsize=16)
    # plt.ylabel('Score $s$', fontsize=16) # ($-\log P(o_{i}|o_{1}\dots o_{i-1}$)
    plt.yticks(fontsize = 16)
    plt.xticks(fontsize = 16)

def plot_seq_offline(seq, draw_dot_at = False):
    x = []
    for i in range(len(seq)):
        x.append(state_dict[seq[i]])
    x = np.stack(x)
    model = hmm.GaussianHMM(n_components=2, covariance_type="diag")
    model.fit(x[:,:]) # excluding last element from seq
    score = []
    for i in range(1,x.shape[0]+1):
        score.append(model.score(x[:i]))
    score = np.array(score)
    print(len(seq), len(score))
    s = score[1:] - score[:-1]
    s = np.insert(s,0, s.max())
    plt.plot(np.array(range(len(s)))+1, -s)
    if draw_dot_at:
        plt.plot(len(s),-s[-1],'ro')
    plt.xlabel('Event number', fontsize=16)
    # plt.ylabel('Score $s$', fontsize=16) # ($-\log P(o_{i}|o_{1}\dots o_{i-1}$)
    plt.yticks(fontsize = 16)
    plt.xticks(fontsize = 16)
# Figure 1
plt.figure(figsize=(16, 4), dpi=300)  # Increased DPI for higher resolution in print
seq = ['0','1','0','1','0','1','0','1']
plt.subplot(131)
plot_seq_offline(seq,True)
plt.title('No anomaly', fontsize = 16)

seq = ['0','1','0','1','0','1','0','0']
plt.subplot(132)
plot_seq_offline(seq,True)
plt.title('Last event has unusual position',  fontsize = 16)

seq = ['0','1','0','1','0','1','0','a']
plt.subplot(133)
plot_seq_offline(seq,True)
plt.title('Anomalous event',  fontsize = 16)
plt.savefig('Figure_1.pdf', format='pdf', bbox_inches='tight')

# Figure 3
plt.figure(figsize=(16, 4), dpi=300)  # Increased DPI for higher resolution in print
seq = ['0','1','0','1','0','1','0','1']
plt.subplot(131)
plot_seq_online(seq,True)
plt.title('No anomaly',  fontsize = 16)

seq = ['0','1','0','1','0','1','0','0']
plt.subplot(132)
plot_seq_online(seq,True)
plt.title('Last event has unusual position',  fontsize = 16)

seq = ['0','1','0','1','0','1','0','a']
plt.subplot(133)
plot_seq_online(seq,True)
plt.title('Anomalous event',  fontsize = 16)
plt.savefig('Figure_3.pdf', format='pdf', bbox_inches='tight')

```
